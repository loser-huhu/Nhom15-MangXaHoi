<!doctype html>
<html lang="vi" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zalo Chat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Fix context menu position */
      #messageContextMenu,
      #sidebarContextMenu {
        position: fixed;
        transform: translate(-50%, 0);
      }

      /* Smooth transitions */
      .message-transition {
        transition: all 0.2s ease;
      }

      /* Scrollbar styling */
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
      }

      .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      .dark .scrollbar-thin::-webkit-scrollbar-track {
        background: #374151;
      }

      .dark .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #4b5563;
      }
    </style>
  </head>
  <body
    class="h-screen flex flex-col overflow-hidden bg-gray-50 dark:bg-gray-900 transition-colors duration-200"
  >
    <!-- Image Viewer -->
    <div
      id="imgViewer"
      class="fixed inset-0 z-50 bg-black/95 hidden items-center justify-center"
    >
      <button
        onclick="closeViewer()"
        class="absolute top-5 right-5 text-white bg-gray-800/80 p-2 rounded-full hover:bg-gray-700/80 backdrop-blur-sm"
      >
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <img
        id="viewerImg"
        src=""
        class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg"
      />
    </div>

    <!-- Group Modal -->
    <div
      id="groupModal"
      class="fixed inset-0 z-40 bg-black/50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl"
      >
        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
          T·∫°o nh√≥m m·ªõi
        </h3>
        <input
          type="text"
          id="newGroupName"
          placeholder="ƒê·∫∑t t√™n nh√≥m..."
          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl mb-4 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
        />
        <div class="mb-4">
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Ch·ªçn th√†nh vi√™n</label
          >
          <div
            id="friendListContainer"
            class="h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-xl p-3 space-y-2 bg-gray-50 dark:bg-gray-700"
          ></div>
        </div>
        <div class="flex justify-end gap-3">
          <button
            onclick="toggleModal('groupModal')"
            class="px-5 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors"
          >
            H·ªßy
          </button>
          <button
            onclick="submitCreateGroup()"
            class="px-5 py-2.5 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors font-medium"
          >
            T·∫°o nh√≥m
          </button>
        </div>
      </div>
    </div>

    <!-- Members Modal -->
    <div
      id="membersModal"
      class="fixed inset-0 z-40 bg-black/50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white">
            Th√†nh vi√™n nh√≥m
          </h3>
          <button
            onclick="toggleModal('membersModal')"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        <div
          id="membersList"
          class="space-y-3 overflow-y-auto flex-1 pr-2"
        ></div>
      </div>
    </div>

    <!-- Nickname Modal -->
    <div
      id="nicknameModal"
      class="fixed inset-0 z-40 bg-black/50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl"
      >
        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
          ƒê·∫∑t bi·ªát danh
        </h3>
        <input
          type="text"
          id="nicknameInput"
          placeholder="Nh·∫≠p bi·ªát danh..."
          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl mb-6 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
        />
        <div class="flex justify-end gap-3">
          <button
            onclick="toggleModal('nicknameModal')"
            class="px-5 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors"
          >
            H·ªßy
          </button>
          <button
            onclick="saveNickname()"
            class="px-5 py-2.5 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors font-medium"
          >
            L∆∞u
          </button>
        </div>
      </div>
    </div>

    <!-- Theme Modal -->
    <div
      id="themeModal"
      class="fixed inset-0 z-40 bg-black/50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl"
      >
        <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
          Ch·ªçn theme chat
        </h3>
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div
            class="theme-option bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-600 rounded-xl p-4 cursor-pointer hover:scale-105 transition-transform"
            onclick="selectTheme('blue', event)" <!-- CHANGED -->
          >
            <div
              class="h-8 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 mb-3"
            ></div>
            <div
              class="text-center text-sm font-medium text-gray-800 dark:text-white"
            >
              Xanh d∆∞∆°ng
            </div>
          </div>
          <div
            class="theme-option bg-green-50 dark:bg-green-900/20 border-2 border-transparent hover:border-green-300 dark:hover:border-green-600 rounded-xl p-4 cursor-pointer hover:scale-105 transition-transform"
            onclick="selectTheme('green', event)" <!-- CHANGED -->
          >
            <div
              class="h-8 rounded-lg bg-gradient-to-r from-green-500 to-green-600 mb-3"
            ></div>
            <div
              class="text-center text-sm font-medium text-gray-800 dark:text-white"
            >
              Xanh l√°
            </div>
          </div>
          <div
            class="theme-option bg-purple-50 dark:bg-purple-900/20 border-2 border-transparent hover:border-purple-300 dark:hover:border-purple-600 rounded-xl p-4 cursor-pointer hover:scale-105 transition-transform"
            onclick="selectTheme('purple', event)" <!-- CHANGED -->
          >
            <div
              class="h-8 rounded-lg bg-gradient-to-r from-purple-500 to-purple-600 mb-3"
            ></div>
            <div
              class="text-center text-sm font-medium text-gray-800 dark:text-white"
            >
              T√≠m
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div
            class="theme-option bg-white dark:bg-gray-700 border-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 rounded-xl p-4 cursor-pointer hover:scale-105 transition-transform"
            onclick="selectTheme('light', event)" <!-- CHANGED -->
          >
            <div
              class="h-8 rounded-lg bg-gradient-to-r from-gray-100 to-gray-300 dark:from-gray-600 dark:to-gray-800 mb-3"
            ></div>
            <div
              class="text-center text-sm font-medium text-gray-800 dark:text-white"
            >
              S√°ng
            </div>
          </div>
          <div
            class="theme-option bg-gray-800 dark:bg-gray-900 border-2 border-transparent hover:border-gray-600 dark:hover:border-gray-700 rounded-xl p-4 cursor-pointer hover:scale-105 transition-transform"
            onclick="selectTheme('dark', event)" <!-- CHANGED -->
          >
            <div
              class="h-8 rounded-lg bg-gradient-to-r from-gray-700 to-gray-900 mb-3"
            ></div>
            <div class="text-center text-sm font-medium text-white">T·ªëi</div>
          </div>
        </div>
        <div class="flex justify-end gap-3">
          <button
            onclick="toggleModal('themeModal')"
            class="px-5 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors"
          >
            H·ªßy
          </button>
          <button
            onclick="saveTheme()"
            class="px-5 py-2.5 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors font-medium"
          >
            √Åp d·ª•ng
          </button>
        </div>
      </div>
    </div>
    <!-- th√™m -->
    <!-- Background Modal -->
    <div
      id="backgroundModal"
      class="fixed inset-0 z-40 bg-black/50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl"
      >
        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
          Ch·ªçn ·∫£nh n·ªÅn chat
        </h3>
        <div class="mb-4">
          <input
            type="file"
            id="backgroundInput"
            accept="image/*"
            class="hidden"
          />
          <div
            class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            onclick="document.getElementById('backgroundInput').click()"
          >
            <i
              data-lucide="upload"
              class="w-12 h-12 mx-auto text-gray-400 mb-3"
            ></i>
            <p class="text-gray-600 dark:text-gray-400">Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh n·ªÅn</p>
            <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">
              PNG, JPG, GIF, WEBP t·ªëi ƒëa 5MB
            </p>
          </div>
          <div id="backgroundPreview" class="mt-4 hidden">
            <img
              id="previewBackground"
              class="w-full h-48 object-cover rounded-xl"
            />
          </div>
        </div>
        <div class="flex justify-end gap-3">
          <button
            onclick="toggleModal('backgroundModal')"
            class="px-5 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors"
          >
            H·ªßy
          </button>
          <button
            onclick="saveBackground()"
            class="px-5 py-2.5 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors font-medium"
          >
            √Åp d·ª•ng
          </button>
        </div>
      </div>
    </div>

    <!-- Emoji Picker -->
    <div
      id="emojiPicker"
      class="fixed bottom-24 right-6 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-2xl shadow-2xl p-4 hidden w-64 h-64 overflow-y-auto z-50"
    >
      <div class="grid grid-cols-6 gap-2">
        <!-- Common emojis -->
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üòÄ')"
          >üòÄ</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üòÇ')"
          >üòÇ</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('ü•∞')"
          >ü•∞</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üòé')"
          >üòé</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üò°')"
          >üò°</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üò≠')"
          >üò≠</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üëç')"
          >üëç</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('‚ù§Ô∏è')"
          >‚ù§Ô∏è</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üî•')"
          >üî•</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üéâ')"
          >üéâ</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üòä')"
          >üòä</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('ü§î')"
          >ü§î</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üò¥')"
          >üò¥</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('ü•∫')"
          >ü•∫</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üôè')"
          >üôè</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üëè')"
          >üëè</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üéÇ')"
          >üéÇ</span
        >
        <span
          class="text-2xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-1 text-center"
          onclick="insertEmoji('üíØ')"
          >üíØ</span
        >
      </div>
    </div>

    <!-- Reaction Picker -->
    <div
      id="reactionPicker"
      class="fixed z-50 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden p-2"
    >
      <div class="flex gap-1">
        <span
          class="text-2xl cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          onclick="addReaction('like')"
          >üëç</span
        >
        <span
          class="text-2xl cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          onclick="addReaction('love')"
          >‚ù§Ô∏è</span
        >
        <span
          class="text-2xl cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          onclick="addReaction('haha')"
          >üòÇ</span
        >
        <span
          class="text-2xl cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          onclick="addReaction('wow')"
          >üòÆ</span
        >
        <span
          class="text-2xl cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          onclick="addReaction('sad')"
          >üò¢</span
        >
        <span
          class="text-2xl cursor-pointer p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          onclick="addReaction('angry')"
          >üò†</span
        >
      </div>
    </div>
    <!-- Profile Modal -->
    <div
      id="profileModal"
      class="fixed inset-0 z-40 bg-black/50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl"
      >
        <div class="text-center mb-6">
          <img
            id="profileModalAvatar"
            src=""
            class="w-28 h-28 rounded-full mx-auto mb-4 border-4 border-white dark:border-gray-800 shadow-lg"
          />
          <h3
            id="profileModalName"
            class="text-2xl font-bold text-gray-800 dark:text-white mb-1"
          ></h3>
          <p
            id="profileModalPhone"
            class="text-gray-500 dark:text-gray-400"
          ></p>
        </div>
        <div class="space-y-4 mb-6">
          <div
            class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl"
          >
            <span class="font-medium text-gray-700 dark:text-gray-300"
              >Ng√†y tham gia:</span
            >
            <span
              id="profileModalJoinDate"
              class="text-gray-900 dark:text-white font-medium"
            ></span>
          </div>
          <div
            class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl"
          >
            <span class="font-medium text-gray-700 dark:text-gray-300"
              >B√†i vi·∫øt:</span
            >
            <span
              id="profileModalPostCount"
              class="text-gray-900 dark:text-white font-medium"
              >0</span
            >
          </div>
          <div
            class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl"
          >
            <span class="font-medium text-gray-700 dark:text-gray-300"
              >B·∫°n b√®:</span
            >
            <span
              id="profileModalFriendCount"
              class="text-gray-900 dark:text-white font-medium"
              >0</span
            >
          </div>
        </div>
        <div class="flex justify-center">
          <button
            onclick="toggleModal('profileModal')"
            class="px-8 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <!-- Context menu cho tin nh·∫Øn -->
    <div
      id="messageContextMenu"
      class="fixed z-50 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden min-w-[180px] py-2"
    >
      <div
        class="msg-menu-item hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-gray-700 dark:text-gray-300"
        onclick="recallMessage()"
      >
        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
        <span>Thu h·ªìi</span>
      </div>
      <div
        class="msg-menu-item hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-gray-700 dark:text-gray-300"
        onclick="editMessage()"
      >
        <i data-lucide="edit" class="w-4 h-4"></i>
        <span>Ch·ªânh s·ª≠a</span>
      </div>
      <div
        class="msg-menu-item hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-gray-700 dark:text-gray-300"
        onclick="togglePinMessage()"
        id="pinMenuItem"
      >
        <i data-lucide="pin" class="w-4 h-4"></i>
        <span>Ghim</span>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
      <div
        class="msg-menu-item hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-gray-700 dark:text-gray-300"
        onclick="copyMessage()"
      >
        <i data-lucide="copy" class="w-4 h-4"></i>
        <span>Sao ch√©p</span>
      </div>
    </div>

    <!-- Context menu cho sidebar -->
    <div
      id="sidebarContextMenu"
      class="fixed z-50 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden min-w-[180px] py-2"
    >
      <div
        class="context-menu-item hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-gray-700 dark:text-gray-300"
        onclick="markAsUnread()"
      >
        <i data-lucide="mail" class="w-4 h-4"></i>
        <span>ƒê√°nh d·∫•u ch∆∞a ƒë·ªçc</span>
      </div>
      <div
        class="context-menu-item hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-gray-700 dark:text-gray-300"
        onclick="muteConversation()"
      >
        <i data-lucide="bell-off" class="w-4 h-4"></i>
        <span>T·∫Øt th√¥ng b√°o</span>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
      <div
        class="context-menu-item hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2.5 cursor-pointer flex items-center gap-3 text-red-600 dark:text-red-400"
        onclick="deleteConversationFromSidebar()"
      >
        <i data-lucide="trash-2" class="w-4 h-4"></i>
        <span>X√≥a h·ªôi tho·∫°i</span>
      </div>
    </div>

    <!-- Main Navigation -->
    <nav
      class="h-16 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-6 bg-white dark:bg-gray-900 shadow-sm z-40"
    >
      <div
        class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity"
        onclick="location.href = '/'"
      >
        <i
          data-lucide="arrow-left"
          class="w-6 h-6 text-gray-700 dark:text-gray-300"
        ></i>
        <span
          class="font-bold text-xl bg-gradient-to-r from-primary-600 to-blue-500 bg-clip-text text-transparent"
          >Zalo Chat Pro</span
        >
      </div>
      <div class="flex items-center gap-2">
        <button
          onclick="toggleDarkMode()"
          class="p-2.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors text-gray-700 dark:text-gray-300"
          title="Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô s√°ng/t·ªëi"
        >
          <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
          <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
        </button>
        <button
          onclick="openGroupModal()"
          class="p-2.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-primary-600 dark:text-primary-400 transition-colors"
          title="T·∫°o nh√≥m"
        >
          <i data-lucide="users-round" class="w-6 h-6"></i>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Sidebar -->
      <div
        class="w-full md:w-1/3 lg:w-1/4 border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex flex-col"
      >
        <div class="p-4 border-b border-gray-200 dark:border-gray-800">
          <div class="relative">
            <i
              data-lucide="search"
              class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
            ></i>
            <input
              type="text"
              placeholder="T√¨m ki·∫øm..."
              class="w-full pl-12 pr-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all"
            />
          </div>
        </div>
        <div
          id="sidebarList"
          class="flex-1 overflow-y-auto scrollbar-thin"
        ></div>
      </div>

      <!-- Chat Area -->
      <div
        class="flex-1 relative bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 flex flex-col"
      >
        <div
          id="welcome-screen"
          class="absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 z-10"
        >
          <div class="text-center p-8">
            <div
              class="w-24 h-24 rounded-full bg-gradient-to-r from-primary-500 to-blue-400 flex items-center justify-center mx-auto mb-6"
            >
              <i data-lucide="message-square" class="w-12 h-12 text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">
              Ch√†o m·ª´ng ƒë·∫øn v·ªõi Zalo Chat Pro
            </h3>
            <p class="text-gray-500 dark:text-gray-400">
              Ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán
            </p>
          </div>
        </div>

        <div
          id="chat-interface"
          class="flex-1 flex-col h-full bg-white dark:bg-gray-900 hidden"
        >
          <!-- Chat Header -->
          <div
            class="h-20 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex items-center px-6 justify-between shadow-sm"
          >
            <div class="flex items-center gap-4">
              <div class="relative">
                <img
                  id="headerAvatar"
                  src=""
                  class="w-14 h-14 rounded-full border-2 border-white dark:border-gray-800 object-cover shadow-md"
                />
                <div
                  class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"
                ></div>
              </div>
              <div>
                <h3
                  id="headerName"
                  class="font-bold text-xl text-gray-800 dark:text-white"
                >
                  Loading...
                </h3>
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span class="text-sm text-green-600 dark:text-green-400"
                    >Online</span
                  >
                </div>
              </div>
            </div>
            <div class="flex gap-2 relative">
              <button
                class="p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors text-gray-700 dark:text-gray-300"
              >
                <i data-lucide="phone" class="w-5 h-5"></i>
              </button>
              <button
                class="p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors text-gray-700 dark:text-gray-300"
              >
                <i data-lucide="video" class="w-5 h-5"></i>
              </button>
              <div class="relative">
                <button
                  id="btnMoreOptions"
                  onclick="toggleMoreOptions(event)"
                  class="p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors text-gray-700 dark:text-gray-300"
                >
                  <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                </button>
                <div
                  id="moreOptionsDropdown"
                  class="hidden absolute right-0 top-14 bg-white dark:bg-gray-800 shadow-2xl rounded-xl py-2 border border-gray-200 dark:border-gray-700 min-w-[200px]"
                ></div>
              </div>
            </div>
          </div>

          <!-- Pinned Message -->
          <div
            id="pinnedMessageContainer"
            class="hidden border-b border-yellow-200 dark:border-yellow-800 bg-gradient-to-r from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 p-4"
          >
            <div class="flex items-center gap-3 mb-2">
              <div class="p-1.5 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
                <i
                  data-lucide="pin"
                  class="w-4 h-4 text-yellow-600 dark:text-yellow-400"
                ></i>
              </div>
              <div
                class="text-sm font-semibold text-yellow-800 dark:text-yellow-300"
              >
                Tin nh·∫Øn ƒëang ƒë∆∞·ª£c ghim
              </div>
              <button
                onclick="unpinMessage()"
                class="ml-auto p-1 hover:bg-yellow-200 dark:hover:bg-yellow-800/40 rounded-lg"
              >
                <i
                  data-lucide="x"
                  class="w-3 h-3 text-yellow-700 dark:text-yellow-300"
                ></i>
              </button>
            </div>
            <div
              id="pinnedMessageContent"
              class="text-gray-700 dark:text-gray-300 ml-10"
            ></div>
          </div>

          <!-- Messages -->
          <div
            id="msgList"
            class="flex-1 overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-white to-gray-50/50 dark:from-gray-900 dark:to-gray-800/50 scrollbar-thin"
          ></div>

          <!-- Message Input -->
          <div
            class="p-4 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 flex gap-3 items-center shadow-lg"
          >
            <div class="relative">
              <button
                onclick="document.getElementById('imgInput').click()"
                class="p-3 text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
              >
                <i data-lucide="image" class="w-5 h-5"></i>
              </button>
            </div>
            <div class="relative">
              <button
                onclick="document.getElementById('fileInput').click()"
                class="p-3 text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
              >
                <i data-lucide="paperclip" class="w-5 h-5"></i>
              </button>
            </div>

            <div
              id="previewArea"
              class="hidden absolute bottom-20 left-6 bg-white dark:bg-gray-800 p-3 border border-gray-200 dark:border-gray-700 shadow-xl rounded-xl flex items-center gap-3"
            >
              <span
                id="previewName"
                class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate max-w-[120px]"
              ></span>
              <img id="previewImg" class="h-12 w-12 object-cover rounded-lg" />
              <button
                onclick="clearFiles()"
                class="text-red-500 hover:text-red-700"
              >
                <i data-lucide="x" class="w-4 h-4"></i>
              </button>
            </div>

            <div class="flex-1 relative">
              <input
                type="text"
                id="inputMsg"
                class="w-full px-5 py-3.5 border border-gray-300 dark:border-gray-700 rounded-full bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none pr-12 transition-all"
                placeholder="Nh·∫≠p tin nh·∫Øn..."
                onkeypress="if (event.key === 'Enter') sendMsg();"
              />
              <!-- th√™m -->
              <button
                onclick="toggleEmojiPicker()"
                class="p-3 text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
                id="emojiBtn"
              >
                <i data-lucide="smile" class="w-5 h-5"></i>
              </button>
              <button
                onclick="sendMsg()"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 p-3 bg-gradient-to-r from-primary-600 to-blue-500 text-white rounded-full hover:opacity-90 transition-opacity shadow-lg"
              >
                <i data-lucide="send" class="w-5 h-5"></i>
              </button>
            </div>
            <input type="file" id="imgInput" hidden accept="image/*" />
            <input type="file" id="fileInput" hidden />
          </div>
        </div>
      </div>
    </div>

    <script>
      // Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
      lucide.createIcons();
      let socket = io();
      let currentUser = null;
      let currentConvId = null;
      let currentConv = null;
      let selectedFile = null;
      let selectedMessageId = null;
      let selectedSidebarItemId = null;
      let selectedTheme = localStorage.getItem("theme") || "light";
      let selectedBackgroundFile = null;
      let selectedMessageForReaction = null;

      // √Åp d·ª•ng theme t·ª´ localStorage khi t·∫£i trang
      if (selectedTheme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      // H√†m helper
      function getAvatar(url) {
        if (!url || url.includes("default"))
          return "/static/uploads/avatars/default_avatar.png";
        if (url.startsWith("http")) return url;
        let clean = url
          .replace("avatars/", "")
          .replace("static/", "")
          .replace("uploads/", "");
        return `/static/uploads/avatars/${clean}`;
      }

      function showToast(message, type = "info") {
        alert(message);
      }

      // --- CH·ª®C NƒÇNG TOGGLE DARK MODE ---
      function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      }

      // --- H√ÄM HI·ªÇN TH·ªä TIN NH·∫ÆN GHIM ---
      function displayPinnedMessage() {
        // CHANGED: Th√™m ki·ªÉm tra an to√†n
        const container = document.getElementById("pinnedMessageContainer");
        const content = document.getElementById("pinnedMessageContent");
        if (!container || !content || !currentConv) {
          container?.classList.add("hidden");
          return;
        }

        if (!currentConv.messages) {
          container.classList.add("hidden");
          return;
        }

        const pinnedMsgs = currentConv.messages.filter((m) => m.is_pinned);
        
        if (pinnedMsgs.length > 0) {
          container.classList.remove("hidden");

          let html = "";
          pinnedMsgs.forEach((msg, index) => {
            let msgContent = "";
            if (msg.file_type === "image") {
              msgContent = `<div class="flex items-center gap-2 mb-2">
                        <img src="/static/uploads/messages/${msg.file_url}" class="rounded h-10 w-10 object-cover">
                        <span class="text-sm text-gray-500 dark:text-gray-400">H√¨nh ·∫£nh</span>
                    </div>`;
            } else if (msg.file_type === "file") {
              msgContent = `<div class="flex items-center gap-2 mb-2">
                        <div class="p-1.5 bg-gray-100 dark:bg-gray-800 rounded">
                            <i data-lucide="file-text" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i>
                        </div>
                        <span class="text-sm truncate">${msg.file_name}</span>
                    </div>`;
            } else if (msg.is_recalled) {
              msgContent = `<div class="text-sm italic text-gray-500 dark:text-gray-400">[Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi]</div>`;
            } else {
              const displayText =
                msg.content.length > 50
                  ? msg.content.substring(0, 50) + "..."
                  : msg.content;
              msgContent = `<div class="text-sm mb-2">${displayText}</div>`;
            }

            html += `<div class="mb-2 pb-2 ${index < pinnedMsgs.length - 1 ? "border-b border-yellow-200 dark:border-yellow-800" : ""}">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-semibold text-yellow-700 dark:text-yellow-300">${msg.sender_name}</span>
                        <button onclick="unpinSpecificMessage(${msg.id})" class="p-1 hover:bg-yellow-200 dark:hover:bg-yellow-800/40 rounded">
                            <i data-lucide="x" class="w-3 h-3 text-yellow-700 dark:text-yellow-300"></i>
                        </button>
                    </div>
                    ${msgContent}
                </div>`;
          });

          content.innerHTML = html;
          lucide.createIcons();
        } else {
          container.classList.add("hidden");
        }
      }

      // --- H√ÄM B·ªé GHIM TIN NH·∫ÆN C·ª§ TH·ªÇ ---
      function unpinSpecificMessage(messageId) {
        socket.emit("pin_message", {
          message_id: parseInt(messageId),
          action: "unpin",
        });
      }

      // CHANGED: Th√™m h√†m unpinMessage
      async function unpinMessage() {
        if (!currentConvId) return;
        
        try {
          socket.emit("unpin_all_messages", {
            conversation_id: currentConvId
          });
        } catch (e) {
          console.error("Unpin error:", e);
        }
      }

      // --- CONTEXT MENU CHO TIN NH·∫ÆN ---
      document.addEventListener("contextmenu", function (e) {
        const msgElement = e.target.closest(".message-item");
        if (msgElement && currentConvId) {
          e.preventDefault();
          selectedMessageId = msgElement.dataset.messageId;
          const menu = document.getElementById("messageContextMenu");
          const pinItem = document.getElementById("pinMenuItem");

          // Ki·ªÉm tra quy·ªÅn
          const msg = currentConv.messages?.find(
            (m) => m.id == selectedMessageId,
          );
          if (msg) {
            const recallItem = menu.querySelector(
              '[onclick="recallMessage()"]',
            );
            const editItem = menu.querySelector('[onclick="editMessage()"]');

            // Ch·ªâ hi·ªán thu h·ªìi v√† ch·ªânh s·ª≠a n·∫øu l√† tin nh·∫Øn c·ªßa m√¨nh
            recallItem.style.display =
              msg.sender_id === currentUser.id ? "flex" : "none";
            editItem.style.display =
              msg.sender_id === currentUser.id && !msg.file_type
                ? "flex"
                : "none";

            // C·∫≠p nh·∫≠t text cho n√∫t ghim
            const pinText = pinItem.querySelector("span");
            pinText.textContent = msg.is_pinned ? "B·ªè ghim" : "Ghim";
          }

          // T√≠nh to√°n v·ªã tr√≠
          const menuWidth = 180;
          const menuHeight = 200;
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;

          let left = e.clientX;
          let top = e.clientY;

          if (left + menuWidth > viewportWidth) {
            left = viewportWidth - menuWidth - 10;
          }

          if (top + menuHeight > viewportHeight) {
            top = viewportHeight - menuHeight - 10;
          }

          menu.style.left = left + "px";
          menu.style.top = top + "px";
          menu.classList.remove("hidden");
        }
      });

      // ƒê√≥ng menu khi click ra ngo√†i
      document.addEventListener("click", function (e) {
        const menu = document.getElementById("messageContextMenu");
        const sidebarMenu = document.getElementById("sidebarContextMenu");
        if (menu && !menu.contains(e.target)) {
          menu.classList.add("hidden");
        }
        if (sidebarMenu && !sidebarMenu.contains(e.target)) {
          sidebarMenu.classList.add("hidden");
        }
      });

      // --- CONTEXT MENU CHO SIDEBAR ---
      document
        .getElementById("sidebarList")
        .addEventListener("contextmenu", function (e) {
          const sidebarItem = e.target.closest("div[data-conv-id]");
          if (sidebarItem) {
            e.preventDefault();
            selectedSidebarItemId = sidebarItem.dataset.convId;
            const menu = document.getElementById("sidebarContextMenu");

            const menuWidth = 180;
            const viewportWidth = window.innerWidth;

            let left = e.clientX;
            if (left + menuWidth > viewportWidth) {
              left = viewportWidth - menuWidth - 10;
            }

            menu.style.left = left + "px";
            menu.style.top = e.clientY + "px";
            menu.classList.remove("hidden");
          }
        });

      // --- H√ÄM RENDER TIN NH·∫ÆN ---
      function renderMsg(msg) {
        const box = document.getElementById("msgList");
        if (!box) return;

        const isMe = msg.sender_id === currentUser.id;
        const div = document.createElement("div");
        div.className = `flex flex-col message-item message-transition ${isMe ? "items-end" : "items-start"}`;
        div.dataset.messageId = msg.id;

        if (isMe) {
          div.classList.add("mine");
        }

        let html = '<div class="flex items-end gap-2 max-w-[80%]">';

        if (!isMe) {
          html += `<img src="${getAvatar(msg.sender_avatar)}" class="w-8 h-8 rounded-full mb-1 flex-shrink-0" />`;
        }

        html += `<div class="flex flex-col ${isMe ? "items-end" : "items-start"}">`;

        if (msg.sender_name && !isMe) {
          html += `<div class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1 ml-1">${msg.sender_name}</div>`;
        }

        let contentHtml = "";
        if (msg.is_recalled) {
          contentHtml = `<div class="px-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-2xl italic text-gray-500 dark:text-gray-400 message-content">
                            [Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi]
                          </div>`;
        } else if (msg.file_type === "image") {
          contentHtml = `<img src="/static/uploads/messages/${msg.file_url}" 
                              class="rounded-2xl max-w-[280px] cursor-zoom-in hover:opacity-90 transition-opacity shadow-lg"
                              onclick="viewImage(this.src)">`;
        } else if (msg.file_type === "file") {
          contentHtml = `<a href="/static/uploads/messages/${msg.file_url}" download 
                              class="flex items-center gap-3 px-4 py-3 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-2xl transition-colors group message-content">
                              <div class="p-2 bg-white dark:bg-gray-900 rounded-lg">
                                <i data-lucide="file-text" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                              </div>
                              <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-800 dark:text-white truncate">${msg.file_name}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">T·∫£i xu·ªëng</div>
                              </div>
                            </a>`;
        } else {
          const bgClass = isMe
            ? "bg-gradient-to-r from-primary-500 to-blue-400 text-white"
            : "bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-white message-content";

          contentHtml = `<div class="px-4 py-3 ${bgClass} rounded-2xl shadow-sm ${isMe ? "rounded-tr-none" : "rounded-tl-none"}">
                            <div class="break-words max-w-[400px] message-text">${msg.content}</div>
                            ${msg.is_edited ? '<span class="text-xs opacity-75 ml-2">(ƒë√£ ch·ªânh s·ª≠a)</span>' : ""}
                          </div>`;
        }

        html += contentHtml;

        // TH√äM PH·∫¶N REACTION N·∫æU C√ì
        if (msg.reactions && Object.keys(msg.reactions).length > 0) {
          html += `<div class="message-reactions flex gap-1 mt-1 ${isMe ? "justify-end" : "justify-start"}">`;
          for (const [type, count] of Object.entries(msg.reactions)) {
            const emojiMap = {
              like: "üëç",
              love: "‚ù§Ô∏è",
              haha: "üòÇ",
              wow: "üòÆ",
              sad: "üò¢",
              angry: "üò†",
            };
            html += `<div class="reaction-badge text-xs px-2 py-1 rounded-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600" onclick="addReactionToMessage(${msg.id}, '${type}')">
                            ${emojiMap[type] || type} ${count}
                         </div>`;
          }
          html += "</div>";
        }

        html += `<div class="flex items-center gap-2 mt-1 text-xs ${isMe ? "justify-end" : "justify-start"}">
                  <span class="text-gray-500 dark:text-gray-400">
                    ${new Date(msg.created_at).toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" })}
                  </span>
                  ${isMe ? '<i data-lucide="check" class="w-4 h-4 text-blue-500"></i>' : ""}
                  ${msg.is_pinned ? '<i data-lucide="pin" class="w-3 h-3 text-yellow-500"></i>' : ""}
                  <button class="reaction-btn opacity-0 hover:opacity-100 transition-opacity p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300" onclick="showReactionPicker(${msg.id}, event)">
                    <i data-lucide="smile-plus" class="w-4 h-4"></i>
                  </button>
                </div>`;

        html += "</div></div>";

        div.innerHTML = html;
        box.appendChild(div);
        lucide.createIcons();

        // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng
        box.scrollTop = box.scrollHeight;
      }

      // --- H√ÄM C·∫¨P NH·∫¨T TIN NH·∫ÆN ---
      function updateMessage(messageId, updates) {
        const msgElement = document.querySelector(
          `[data-message-id="${messageId}"]`,
        );
        if (!msgElement) return;

        // C·∫≠p nh·∫≠t trong currentConv.messages
        const msgIndex = currentConv.messages.findIndex(
          (m) => m.id == messageId,
        );
        if (msgIndex !== -1) {
          currentConv.messages[msgIndex] = {
            ...currentConv.messages[msgIndex],
            ...updates,
          };
        }

        // Render l·∫°i tin nh·∫Øn
        msgElement.remove();
        renderMsg(currentConv.messages[msgIndex]);

        // C·∫≠p nh·∫≠t pinned message n·∫øu c·∫ßn
        displayPinnedMessage();
      }

      // --- H√ÄM X·ª¨ L√ù TIN NH·∫ÆN ---
      async function recallMessage() {
        if (!selectedMessageId) return;
        if (!confirm("Thu h·ªìi tin nh·∫Øn n√†y?")) return;

        try {
          socket.emit("recall_message", {
            message_id: parseInt(selectedMessageId),
          });
          document.getElementById("messageContextMenu").classList.add("hidden");
        } catch (e) {
          console.error("Recall error:", e);
        }
      }

      async function editMessage() {
        if (!selectedMessageId) return;

        // T√¨m tin nh·∫Øn
        const msg = currentConv.messages?.find(
          (m) => m.id == selectedMessageId,
        );
        if (!msg || msg.file_type) return;

        const newContent = prompt("Ch·ªânh s·ª≠a tin nh·∫Øn:", msg.content || "");
        if (
          newContent === null ||
          newContent.trim() === "" ||
          newContent === msg.content
        )
          return;

        try {
          socket.emit("edit_message", {
            message_id: parseInt(selectedMessageId),
            content: newContent.trim(),
          });
          document.getElementById("messageContextMenu").classList.add("hidden");
        } catch (e) {
          console.error("Edit error:", e);
        }
      }

      async function togglePinMessage() {
        if (!selectedMessageId) return;
        try {
          const msg = currentConv.messages?.find(
            (m) => m.id == selectedMessageId,
          );
          socket.emit("pin_message", {
            message_id: parseInt(selectedMessageId),
            action: msg?.is_pinned ? "unpin" : "pin",
          });
          document.getElementById("messageContextMenu").classList.add("hidden");
        } catch (e) {
          console.error("Pin error:", e);
        }
      }

      function copyMessage() {
        const msgElement = document.querySelector(
          `[data-message-id="${selectedMessageId}"]`,
        );
        if (msgElement) {
          const text =
            msgElement.querySelector(".break-words")?.textContent ||
            msgElement.textContent;
          navigator.clipboard.writeText(text).then(() => {
            alert("ƒê√£ sao ch√©p tin nh·∫Øn");
          });
        }
        document.getElementById("messageContextMenu").classList.add("hidden");
      }

      // --- SOCKET LISTENERS ---
      socket.on("message_recalled", (data) => {
        if (currentConvId == data.conversation_id) {
          updateMessage(data.message_id, {
            is_recalled: true,
            content: "[Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi]",
          });
        }
      });

      socket.on("message_edited", (data) => {
        if (currentConvId == data.conversation_id) {
          updateMessage(data.message_id, {
            content: data.new_content,
            is_edited: true,
          });
        }
      });

      socket.on("message_pinned", (data) => {
        if (currentConvId == data.conversation_id) {
          // C·∫≠p nh·∫≠t t·∫•t c·∫£ tin nh·∫Øn trong cu·ªôc tr√≤ chuy·ªán
          if (currentConv.messages) {
            currentConv.messages.forEach((msg) => {
              // Ki·ªÉm tra xem tin nh·∫Øn n√†y c√≥ trong pinned_messages kh√¥ng
              const isPinned = data.pinned_messages?.some(
                (pm) => pm.id === msg.id,
              );
              msg.is_pinned = isPinned || false;
            });

            // Render l·∫°i t·∫•t c·∫£ tin nh·∫Øn
            const box = document.getElementById("msgList");
            box.innerHTML = "";
            currentConv.messages.sort(
              (a, b) => new Date(a.created_at) - new Date(b.created_at),
            );
            currentConv.messages.forEach(renderMsg);

            // C·∫≠p nh·∫≠t v√πng ghim
            displayPinnedMessage();
          }
        }
      });

      // CHANGED: Th√™m socket listener cho unpin all
      socket.on("all_messages_unpinned", (data) => {
        if (currentConvId == data.conversation_id) {
          // C·∫≠p nh·∫≠t t·∫•t c·∫£ tin nh·∫Øn
          if (currentConv.messages) {
            currentConv.messages.forEach(msg => {
              msg.is_pinned = false;
            });
            
            // Render l·∫°i t·∫•t c·∫£ tin nh·∫Øn
            const box = document.getElementById("msgList");
            box.innerHTML = "";
            currentConv.messages.sort(
              (a, b) => new Date(a.created_at) - new Date(b.created_at),
            );
            currentConv.messages.forEach(renderMsg);
            
            // ·∫®n pinned message container
            displayPinnedMessage();
          }
        }
      });

      socket.on("message_reacted", (data) => {
        if (currentConvId == data.conversation_id) {
          // C·∫≠p nh·∫≠t reaction cho tin nh·∫Øn
          const msgIndex = currentConv.messages?.findIndex(
            (m) => m.id == data.message_id,
          );
          if (msgIndex !== -1 && currentConv.messages) {
            currentConv.messages[msgIndex].reactions = data.reaction_summary;
            updateMessageReactions(data.message_id, data.reaction_summary);
          }
        }
      });

      // Nh·∫≠n tin nh·∫Øn m·ªõi
      socket.on("receive_message", (msg) => {
        if (currentConvId == msg.conversation_id) {
          if (!currentConv.messages) currentConv.messages = [];
          currentConv.messages.push(msg);
          renderMsg(msg);
        }
        loadSidebar();
      });

      // --- C·∫¨P NH·∫¨T MENU 3 CH·∫§M ---
      function toggleMoreOptions(event) {
        // CHANGED: Th√™m ki·ªÉm tra event v√† currentConv
        event?.stopPropagation();
        const menu = document.getElementById("moreOptionsDropdown");
        if (!menu || !currentConv) return;

        let html = "";
        if (currentConv.is_group) {
          html = `
                <div class="px-1 py-1">
                    <a href="#" onclick="viewGroupMembers()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Xem th√†nh vi√™n</span>
                    </a>
                    <a href="#" onclick="openNicknameModal()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="tag" class="w-5 h-5"></i>
                        <span>ƒê·∫∑t bi·ªát danh</span>
                    </a>
                    <a href="#" onclick="openThemeModal()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="palette" class="w-5 h-5"></i>
                        <span>ƒê·ªïi theme chat</span>
                    </a>
                    <a href="#" onclick="openBackgroundModal()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="image" class="w-5 h-5"></i>
                        <span>ƒê·ªïi ·∫£nh n·ªÅn chat</span>
                    </a>
                    <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                    <a href="#" onclick="viewProfile()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <span>Xem h·ªì s∆°</span>
                    </a>
                    <a href="#" onclick="leaveGroup()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-red-600 dark:text-red-400 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>R·ªùi nh√≥m</span>
                    </a>
                </div>
            `;
        } else {
          html = `
                <div class="px-1 py-1">
                    <a href="#" onclick="viewProfile()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <span>Xem h·ªì s∆°</span>
                    </a>
                    <a href="#" onclick="openNicknameModal()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="tag" class="w-5 h-5"></i>
                        <span>ƒê·∫∑t bi·ªát danh</span>
                    </a>
                    <a href="#" onclick="openThemeModal()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="palette" class="w-5 h-5"></i>
                        <span>ƒê·ªïi theme chat</span>
                    </a>
                    <a href="#" onclick="openBackgroundModal()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 transition-colors">
                        <i data-lucide="image" class="w-5 h-5"></i>
                        <span>ƒê·ªïi ·∫£nh n·ªÅn chat</span>
                    </a>
                    <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                    <a href="#" onclick="deleteConversation()" class="flex items-center gap-3 px-4 py-2.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-red-600 dark:text-red-400 transition-colors">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        <span>X√≥a h·ªôi tho·∫°i</span>
                    </a>
                </div>
            `;
        }

        menu.innerHTML = html;
        lucide.createIcons();
        menu.classList.toggle("hidden");
      }

      // --- H√ÄM XEM H·ªí S∆† ---
      async function viewProfile() {
        try {
          let targetUserId;
          if (currentConv.is_group) {
            targetUserId = currentUser.id;
          } else {
            const otherUser = currentConv.users?.find(
              (u) => u.id !== currentUser.id,
            );
            targetUserId = otherUser ? otherUser.id : currentUser.id;
          }

          const res = await fetch(`/chat/user-profile/${targetUserId}`);
          const data = await res.json();

          if (data.success) {
            const user = data.user;
            document.getElementById("profileModalAvatar").src = getAvatar(
              user.avatar_url,
            );
            document.getElementById("profileModalName").textContent = user.name;
            document.getElementById("profileModalPhone").textContent =
              user.phone_number;
            document.getElementById("profileModalJoinDate").textContent =
              new Date(user.created_at).toLocaleDateString("vi-VN");
            document.getElementById("profileModalPostCount").textContent =
              user.post_count || 0;
            document.getElementById("profileModalFriendCount").textContent =
              user.friend_count || 0;

            toggleModal("profileModal");
            document
              .getElementById("moreOptionsDropdown")
              .classList.add("hidden");
          }
        } catch (e) {
          console.error("Profile error:", e);
        }
      }

      // --- H√ÄM ƒê·∫∂T BI·ªÜT DANH ---
      function openNicknameModal() {
        toggleModal("nicknameModal");
        document.getElementById("moreOptionsDropdown").classList.add("hidden");
      }

      async function saveNickname() {
        const nickname = document.getElementById("nicknameInput").value.trim();
        if (!currentConvId) return;

        try {
          let targetUserId = null;
          if (!currentConv.is_group) {
            const otherUser = currentConv.users?.find(
              (u) => u.id !== currentUser.id,
            );
            targetUserId = otherUser ? otherUser.id : null;
          }

          const res = await fetch(
            `/chat/conversation/${currentConvId}/set-nickname`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ target_user_id: targetUserId, nickname }),
            },
          );

          const data = await res.json();
          if (data.success) {
            // C·∫≠p nh·∫≠t bi·ªát danh trong currentConv
            if (!currentConv.settings) currentConv.settings = {};
            currentConv.settings.nickname = nickname;

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            updateHeaderDisplay();

            alert("ƒê√£ l∆∞u bi·ªát danh");
            toggleModal("nicknameModal");
          }
        } catch (e) {
          console.error("Nickname error:", e);
        }
      }

      // --- H√ÄM ƒê·ªîI THEME ---
      function openThemeModal() {
        toggleModal("themeModal");
        document.getElementById("moreOptionsDropdown").classList.add("hidden");
      }

      let selectedThemeOption = "default";

      // CHANGED: S·ª≠a h√†m selectTheme ƒë·ªÉ nh·∫≠n tham s·ªë event
      function selectTheme(theme, event) {
        selectedThemeOption = theme;
        document.querySelectorAll(".theme-option").forEach((el) => {
          el.classList.remove(
            "border-blue-300",
            "dark:border-blue-600",
            "border-green-300",
            "dark:border-green-600",
            "border-purple-300",
            "dark:border-purple-600",
            "border-gray-300",
            "dark:border-gray-600",
            "border-gray-600",
            "dark:border-gray-700",
          );
        });

        const clickedEl = event.target.closest(".theme-option");
        if (clickedEl) {
          if (theme === "blue") {
            clickedEl.classList.add("border-blue-300", "dark:border-blue-600");
          } else if (theme === "green") {
            clickedEl.classList.add(
              "border-green-300",
              "dark:border-green-600",
            );
          } else if (theme === "purple") {
            clickedEl.classList.add(
              "border-purple-300",
              "dark:border-purple-600",
            );
          } else if (theme === "light") {
            clickedEl.classList.add("border-gray-300", "dark:border-gray-600");
          } else if (theme === "dark") {
            clickedEl.classList.add("border-gray-600", "dark:border-gray-700");
          } else if (theme === "default") {
            clickedEl.classList.add("border-blue-300", "dark:border-blue-600");
          }
        }
      }

      async function saveTheme() {
        if (!currentConvId) return;
        try {
          const res = await fetch(
            `/chat/conversation/${currentConvId}/set-theme`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ theme: selectedThemeOption }),
            },
          );

          const data = await res.json();
          if (data.success) {
            // √Åp d·ª•ng theme ngay l·∫≠p t·ª©c
            applyTheme(selectedThemeOption);
            alert("ƒê√£ √°p d·ª•ng theme");
            toggleModal("themeModal");
          }
        } catch (e) {
          console.error("Theme error:", e);
        }
      }

      // --- H√ÄM √ÅP D·ª§NG THEME ---
      function applyTheme(theme) {
        const msgList = document.getElementById("msgList");

        // X√≥a t·∫•t c·∫£ class theme c≈©
        msgList.classList.remove(
          "theme-blue",
          "theme-green",
          "theme-purple",
          "theme-light",
          "theme-dark",
          "theme-default",
        );

        // √Åp d·ª•ng theme m·ªõi
        msgList.classList.add(`theme-${theme}`);

        // L∆∞u v√†o localStorage
        localStorage.setItem(`chat-theme-${currentConvId}`, theme);

        // Th√™m CSS ƒë·ªông cho theme
        if (!document.getElementById("theme-styles")) {
          const style = document.createElement("style");
          style.id = "theme-styles";
          style.textContent = `
                .theme-blue { background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%) !important; }
                .theme-green { background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%) !important; }
                .theme-purple { background: linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%) !important; }
                .theme-dark { background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important; }
                .theme-light { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important; }
                .theme-default { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important; }
            `;
          document.head.appendChild(style);
        }
      }

      // --- H√ÄM ƒê·ªîI ·∫¢NH N·ªÄN ---
      function openBackgroundModal() {
        toggleModal("backgroundModal");
        document.getElementById("moreOptionsDropdown").classList.add("hidden");
      }

      document.getElementById("backgroundInput").onchange = function (e) {
        if (e.target.files[0]) {
          selectedBackgroundFile = e.target.files[0];
          const preview = document.getElementById("previewBackground");
          preview.src = URL.createObjectURL(selectedBackgroundFile);
          document
            .getElementById("backgroundPreview")
            .classList.remove("hidden");
        }
      };

      async function saveBackground() {
        if (!selectedBackgroundFile || !currentConvId) return;

        const formData = new FormData();
        formData.append("background", selectedBackgroundFile);

        try {
          const res = await fetch(
            `/chat/conversation/${currentConvId}/set-background`,
            {
              method: "POST",
              body: formData,
            },
          );

          const data = await res.json();
          if (data.success) {
            // √Åp d·ª•ng ·∫£nh n·ªÅn ngay l·∫≠p t·ª©c
            applyBackground(data.filename);
            alert("ƒê√£ √°p d·ª•ng ·∫£nh n·ªÅn");
            toggleModal("backgroundModal");
          }
        } catch (e) {
          console.error("Background error:", e);
        }
      }

      // CHANGED: S·ª≠a h√†m applyBackground ƒë·ªÉ tr√°nh xung ƒë·ªôt CSS
      function applyBackground(filename) {
        const msgList = document.getElementById("msgList");
        if (!msgList) return;
        
        // X√≥a t·∫•t c·∫£ class theme ƒë·ªÉ tr√°nh xung ƒë·ªôt
        msgList.classList.remove(
          "theme-blue", "theme-green", "theme-purple", 
          "theme-light", "theme-dark", "theme-default"
        );
        
        if (filename) {
          // S·ª≠ d·ª•ng style inline
          msgList.style.backgroundImage = `url('/static/uploads/backgrounds/${filename}')`;
          msgList.style.backgroundSize = "cover";
          msgList.style.backgroundAttachment = "fixed";
          msgList.style.backgroundPosition = "center";
          msgList.style.backgroundRepeat = "no-repeat";
          
          // Th√™m overlay cho ƒë·ªô t∆∞∆°ng ph·∫£n
          msgList.style.position = "relative";
          
          let overlay = document.getElementById("background-overlay");
          if (!overlay) {
            overlay = document.createElement("div");
            overlay.id = "background-overlay";
            overlay.style.position = "absolute";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.right = "0";
            overlay.style.bottom = "0";
            overlay.style.backgroundColor = "rgba(255, 255, 255, 0.7)";
            overlay.style.zIndex = "-1";
            msgList.prepend(overlay);
          }
        } else {
          // Reset v·ªÅ m·∫∑c ƒë·ªãnh
          msgList.style.backgroundImage = "";
          msgList.style.backgroundColor = "";
          
          const overlay = document.getElementById("background-overlay");
          if (overlay) overlay.remove();
        }
        
        // L∆∞u v√†o localStorage
        if (filename) {
          localStorage.setItem(`chat-bg-${currentConvId}`, filename);
        } else {
          localStorage.removeItem(`chat-bg-${currentConvId}`);
        }
      }

      // --- H√ÄM UPDATE HEADER DISPLAY ---
      function updateHeaderDisplay() {
        const headerName = document.getElementById("headerName");
        if (!currentConv || !headerName) return;

        let displayName = currentConv.name;

        // N·∫øu c√≥ bi·ªát danh trong settings
        if (currentConv.settings && currentConv.settings.nickname) {
          displayName = `${currentConv.name} (${currentConv.settings.nickname})`;
        }

        headerName.textContent = displayName;
      }

      // --- H√ÄM CHO SIDEBAR CONTEXT MENU ---
      function markAsUnread() {
        if (!selectedSidebarItemId) return;
        alert("ƒê√£ ƒë√°nh d·∫•u l√† ch∆∞a ƒë·ªçc (ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn)");
        document.getElementById("sidebarContextMenu").classList.add("hidden");
      }

      function muteConversation() {
        if (!selectedSidebarItemId) return;
        alert("ƒê√£ t·∫Øt th√¥ng b√°o (ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn)");
        document.getElementById("sidebarContextMenu").classList.add("hidden");
      }

      function deleteConversationFromSidebar() {
        if (!selectedSidebarItemId) return;
        if (confirm("X√≥a h·ªôi tho·∫°i n√†y?")) {
          fetch(`/chat/conversation/${selectedSidebarItemId}`, {
            method: "DELETE",
          }).then(() => location.reload());
        }
        document.getElementById("sidebarContextMenu").classList.add("hidden");
      }

      // --- CORE CHAT FUNCTIONS ---
      async function loadSidebar() {
        try {
          const res = await fetch("/chat/conversations");
          const data = await res.json();
          const list = document.getElementById("sidebarList");
          list.innerHTML = "";

          if (data.success && data.conversations) {
            data.conversations.forEach((c) => {
              const div = document.createElement("div");
              div.className = `p-4 flex gap-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors ${currentConvId == c.id ? "bg-primary-50 dark:bg-primary-900/20 border-r-2 border-primary-500" : ""}`;
              div.dataset.convId = c.id;
              div.onclick = () => loadChatContent(c.id);

              let preview = c.last_message
                ? c.last_message.file_type
                  ? `[${c.last_message.file_type === "image" ? "H√¨nh ·∫£nh" : "T·ªáp tin"}]`
                  : c.last_message.content
                : "B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán";

              if (preview.length > 30) {
                preview = preview.substring(0, 30) + "...";
              }

              let avatar = getAvatar(c.avatar);
              if (c.is_group) {
                avatar =
                  "https://cdn-icons-png.flaticon.com/512/681/681494.png";
              }

              div.innerHTML = `
                        <div class="relative">
                            <img src="${avatar}" class="w-14 h-14 rounded-xl object-cover border border-gray-200 dark:border-gray-700">
                            ${c.is_group ? '<div class="absolute -bottom-1 -right-1 bg-primary-500 text-white p-1 rounded-full"><i data-lucide="users" class="w-3 h-3"></i></div>' : ""}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-gray-800 dark:text-white truncate">${c.name}</h4>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${c.last_message ? new Date(c.last_message.created_at).toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" }) : ""}</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${preview}</p>
                        </div>
                    `;
              list.appendChild(div);
            });
            lucide.createIcons();
          }
        } catch (e) {
          console.error("Load sidebar error:", e);
        }
      }

      async function loadChatContent(convId) {
        try {
          currentConvId = convId;
          const res = await fetch(`/chat/detail/${convId}`);
          const data = await res.json();

          if (data.success) {
            currentConv = data.conversation;

            // ·∫®n m√†n h√¨nh ch√†o, hi·ªán giao di·ªán chat
            document.getElementById("welcome-screen").classList.add("hidden");
            document
              .getElementById("chat-interface")
              .classList.remove("hidden");
            document.getElementById("chat-interface").classList.add("flex");

            // C·∫¨P NH·∫¨T HI·ªÇN TH·ªä T√äN V·ªöI BI·ªÜT DANH
            updateHeaderDisplay();

            // C·∫¨P NH·∫¨T AVATAR
            let avatar = getAvatar(currentConv.avatar);
            if (currentConv.is_group) {
              avatar = "https://cdn-icons-png.flaticon.com/512/681/681494.png";
            }
            document.getElementById("headerAvatar").src = avatar;

            // X√ìA TIN NH·∫ÆN C≈® V√Ä RENDER L·∫†I
            const box = document.getElementById("msgList");
            box.innerHTML = "";

            // √ÅP D·ª§NG THEME CHO KHUNG CHAT
            if (currentConv.settings && currentConv.settings.theme) {
              applyTheme(currentConv.settings.theme);
              selectedThemeOption = currentConv.settings.theme;
            } else {
              // Ki·ªÉm tra localStorage n·∫øu kh√¥ng c√≥ trong settings
              const savedTheme = localStorage.getItem(
                `chat-theme-${currentConvId}`,
              );
              if (savedTheme) {
                applyTheme(savedTheme);
                selectedThemeOption = savedTheme;
              } else {
                // Theme m·∫∑c ƒë·ªãnh
                applyTheme("default");
                selectedThemeOption = "default";
              }
            }

            // √ÅP D·ª§NG ·∫¢NH N·ªÄN
            if (currentConv.settings && currentConv.settings.background_image) {
              applyBackground(currentConv.settings.background_image);
            } else {
              // Ki·ªÉm tra localStorage
              const savedBg = localStorage.getItem(`chat-bg-${currentConvId}`);
              if (savedBg) {
                applyBackground(savedBg);
              } else {
                // X√≥a ·∫£nh n·ªÅn n·∫øu c√≥
                document.getElementById("msgList").style.backgroundImage = "";
              }
            }

            // RENDER TIN NH·∫ÆN
            if (currentConv.messages) {
              // ƒê·∫£m b·∫£o messages ƒë∆∞·ª£c s·∫Øp x·∫øp theo th·ªùi gian (m·ªõi nh·∫•t cu·ªëi c√πng)
              currentConv.messages.sort(
                (a, b) => new Date(a.created_at) - new Date(b.created_at),
              );
              currentConv.messages.forEach(renderMsg);
            }

            // HI·ªÇN TH·ªä TIN NH·∫ÆN ƒê∆Ø·ª¢C GHIM
            displayPinnedMessage();

            // JOIN SOCKET ROOM
            socket.emit("join_conversation", { conversation_id: convId });

            // C·∫¨P NH·∫¨T URL
            window.history.pushState({}, "", `/chat?id=${convId}`);

            // ·∫®N DROPDOWN N·∫æU ƒêANG M·ªû
            document
              .getElementById("moreOptionsDropdown")
              .classList.add("hidden");

            // RELOAD SIDEBAR ƒê·ªÇ C·∫¨P NH·∫¨T LAST MESSAGE
            loadSidebar();
          }
        } catch (e) {
          console.error("Load chat error:", e);
        }
      }

      async function sendMsg() {
        const input = document.getElementById("inputMsg");
        const txt = input.value.trim();
        if (!txt && !selectedFile) return;

        let fileData = { url: null, name: null, type: null };
        if (selectedFile) {
          const fd = new FormData();
          fd.append("file", selectedFile);
          try {
            const res = await fetch("/upload/file", {
              method: "POST",
              body: fd,
            });
            const d = await res.json();
            if (d.success)
              fileData = {
                url: d.filename,
                name: d.original_name,
                type: d.type,
              };
          } catch (e) {}
        }

        socket.emit("send_message", {
          conversation_id: currentConvId,
          content: txt,
          file_url: fileData.url,
          file_name: fileData.name,
          file_type: fileData.type,
        });

        input.value = "";
        clearFiles();
        input.focus();
      }

      // --- GROUP ACTIONS ---
      async function viewGroupMembers() {
        try {
          const res = await fetch(`/chat/group/${currentConvId}/members`);
          const data = await res.json();
          if (data.success) {
            const list = document.getElementById("membersList");
            list.innerHTML = "";
            data.members.forEach((m) => {
              let avatar = getAvatar(m.avatar_url);
              list.innerHTML += `
                        <div class="flex items-center justify-between p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors">
                            <div class="flex items-center gap-3">
                                <img src="${avatar}" class="w-12 h-12 rounded-full object-cover border border-gray-200 dark:border-gray-700">
                                <div>
                                    <div class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                                        ${m.name} 
                                        ${m.is_admin ? '<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 text-xs rounded-lg">Qu·∫£n tr·ªã vi√™n</span>' : ""}
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">${m.phone_number}</div>
                                </div>
                            </div>
                        </div>`;
            });
            lucide.createIcons();
            toggleModal("membersModal");
            document
              .getElementById("moreOptionsDropdown")
              .classList.add("hidden");
          }
        } catch (e) {}
      }

      async function leaveGroup() {
        if (!confirm("R·ªùi nh√≥m n√†y?")) return;
        const res = await fetch("/chat/group/leave", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ conversation_id: currentConvId }),
        });
        const data = await res.json();
        if (data.success) location.reload();
      }

      async function deleteConversation() {
        if (!confirm("X√≥a h·ªôi tho·∫°i n√†y?")) return;
        await fetch(`/chat/conversation/${currentConvId}`, {
          method: "DELETE",
        });
        location.reload();
      }

      // --- REACTION FUNCTIONS ---
      function showReactionPicker(messageId, event) {
        event.stopPropagation();
        selectedMessageForReaction = messageId;
        const picker = document.getElementById("reactionPicker");

        // ƒê·∫∑t v·ªã tr√≠
        picker.style.left = `${event.clientX - 100}px`;
        picker.style.top = `${event.clientY - 60}px`;

        picker.classList.remove("hidden");

        // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
        setTimeout(() => {
          picker.classList.add("hidden");
        }, 3000);
      }

      function addReaction(reactionType) {
        if (!selectedMessageForReaction) return;

        socket.emit("reaction_message", {
          message_id: parseInt(selectedMessageForReaction),
          reaction_type: reactionType,
        });

        document.getElementById("reactionPicker").classList.add("hidden");
      }

      function addReactionToMessage(messageId, reactionType) {
        socket.emit("reaction_message", {
          message_id: parseInt(messageId),
          reaction_type: reactionType,
        });
      }

      function updateMessageReactions(messageId, reactionSummary) {
        const msgElement = document.querySelector(
          `[data-message-id="${messageId}"]`,
        );
        if (!msgElement) return;

        let reactionsContainer = msgElement.querySelector(".message-reactions");
        if (!reactionsContainer) {
          reactionsContainer = document.createElement("div");
          reactionsContainer.className = "message-reactions";
          msgElement.appendChild(reactionsContainer);
        }

        // C·∫≠p nh·∫≠t reactions
        reactionsContainer.innerHTML = "";
        for (const [type, count] of Object.entries(reactionSummary || {})) {
          if (count > 0) {
            const emojiMap = {
              like: "üëç",
              love: "‚ù§Ô∏è",
              haha: "üòÇ",
              wow: "üòÆ",
              sad: "üò¢",
              angry: "üò†",
            };

            const badge = document.createElement("div");
            badge.className =
              "reaction-badge text-xs px-2 py-1 rounded-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600";
            badge.innerHTML = `${emojiMap[type] || type} ${count}`;
            badge.onclick = () => addReactionToMessage(messageId, type);
            reactionsContainer.appendChild(badge);
          }
        }
      }

      // --- EMOJI PICKER FUNCTIONS ---
      function toggleEmojiPicker() {
        const picker = document.getElementById("emojiPicker");
        picker.classList.toggle("hidden");

        if (!picker.classList.contains("hidden")) {
          setTimeout(() => {
            document.addEventListener("click", closeEmojiPickerOnClick);
          }, 100);
        }
      }

      function closeEmojiPickerOnClick(e) {
        const picker = document.getElementById("emojiPicker");
        const emojiBtn = document.getElementById("emojiBtn");
        if (
          !picker.contains(e.target) &&
          (!emojiBtn || !emojiBtn.contains(e.target))
        ) {
          picker.classList.add("hidden");
          document.removeEventListener("click", closeEmojiPickerOnClick);
        }
      }

      function insertEmoji(emoji) {
        const input = document.getElementById("inputMsg");
        input.value += emoji;
        input.focus();

        document.getElementById("emojiPicker").classList.add("hidden");
      }

      // --- HELPERS ---
      window.viewImage = (src) => {
        document.getElementById("viewerImg").src = src;
        document.getElementById("imgViewer").classList.remove("hidden");
        document.getElementById("imgViewer").classList.add("flex");
      };
      window.closeViewer = () => {
        document.getElementById("imgViewer").classList.add("hidden");
        document.getElementById("imgViewer").classList.remove("flex");
      };
      window.toggleModal = (id) => {
        const el = document.getElementById(id);
        el.classList.toggle("hidden");
        el.classList.toggle("flex");
      };

      function handleFile(e) {
        if (e.target.files[0]) {
          selectedFile = e.target.files[0];
          document.getElementById("previewArea").classList.remove("hidden");
          document.getElementById("previewName").innerText = selectedFile.name;
          if (selectedFile.type.startsWith("image/")) {
            document.getElementById("previewImg").src =
              URL.createObjectURL(selectedFile);
            document.getElementById("previewImg").classList.remove("hidden");
          } else {
            document.getElementById("previewImg").classList.add("hidden");
          }
        }
      }
      window.clearFiles = () => {
        selectedFile = null;
        document.getElementById("previewArea").classList.add("hidden");
        document.getElementById("imgInput").value = "";
        document.getElementById("fileInput").value = "";
      };
      document.getElementById("imgInput").onchange = handleFile;
      document.getElementById("fileInput").onchange = handleFile;

      async function openGroupModal() {
        toggleModal("groupModal");
        const res = await fetch("/chat/friends");
        const data = await res.json();
        const list = document.getElementById("friendListContainer");
        list.innerHTML = "";
        if (data.friends) {
          data.friends.forEach((f) => {
            list.innerHTML += `
                    <label class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg cursor-pointer transition-colors">
                        <input type="checkbox" value="${f.id}" class="group-check w-5 h-5 text-primary-600 rounded border-gray-300 dark:border-gray-600 focus:ring-primary-500">
                        <img src="${getAvatar(f.avatar_url)}" class="w-10 h-10 rounded-full">
                        <span class="font-medium text-gray-800 dark:text-white">${f.name}</span>
                    </label>`;
          });
        }
      }

      async function submitCreateGroup() {
        const name = document.getElementById("newGroupName").value;
        const ids = Array.from(
          document.querySelectorAll(".group-check:checked"),
        ).map((c) => parseInt(c.value));
        if (!name || ids.length === 0)
          return alert("Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn th√†nh vi√™n");

        const res = await fetch("/chat/group/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, members: ids }),
        });
        const data = await res.json();
        if (data.success) {
          toggleModal("groupModal");
          loadChatContent(data.conversation_id);
        }
      }

      // --- INIT ---
      async function init() {
        try {
          const res = await fetch("/auth/check-auth");
          const data = await res.json();
          if (!data.authenticated) return (location.href = "/login");
          currentUser = data.user;

          // √Åp d·ª•ng theme t·ª´ user settings
          if (currentUser.theme) {
            selectedTheme = currentUser.theme;
            if (selectedTheme === "dark") {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }
          }

          socket.on("connect", () => {
            socket.emit("join_conversation", {
              conversation_id: `user_${currentUser.id}`,
            });
          });

          // CHANGED: Th√™m x·ª≠ l√Ω l·ªói socket
          socket.on("connect_error", (error) => {
            console.error("Socket connection error:", error);
            showToast("K·∫øt n·ªëi th·∫•t b·∫°i. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...", "error");
          });

          socket.on("disconnect", (reason) => {
            console.log("Socket disconnected:", reason);
            if (reason === "io server disconnect") {
              socket.connect();
            }
          });

          document.addEventListener("click", (e) => {
            const menu = document.getElementById("moreOptionsDropdown");
            const btn = document.getElementById("btnMoreOptions");
            if (
              menu &&
              !menu.contains(e.target) &&
              (!btn || !btn.contains(e.target))
            ) {
              menu.classList.add("hidden");
            }
          });

          await loadSidebar();

          const params = new URLSearchParams(location.search);
          const targetId = params.get("user");
          if (targetId) {
            const r = await fetch(`/chat/find-or-create/${targetId}`);
            const d = await r.json();
            if (d.success) loadChatContent(d.conversation_id);
          }
        } catch (e) {
          console.error("Init error:", e);
        }
      }

      init();
    </script>
  </body>
</html>