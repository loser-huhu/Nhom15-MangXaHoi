<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hồ sơ cá nhân</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <style>
      :root {
        --accent-color: #3b82f6;
      } /* Màu mặc định */

      /* Áp dụng màu chủ đạo */
      .text-accent {
        color: var(--accent-color) !important;
      }
      .bg-accent {
        background-color: var(--accent-color) !important;
        color: white;
      }
      .border-accent {
        border-color: var(--accent-color) !important;
      }
      .ring-accent:focus {
        --tw-ring-color: var(--accent-color) !important;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #f0f4ff 0%, #e6f7ff 100%);
      }
      .theme-color {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
      }
      .theme-color.selected {
        border-color: var(--accent-color);
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }

      /* Dark mode */
      body.dark-mode {
        background: #111827;
        color: #f3f4f6;
      }
      body.dark-mode .bg-white {
        background-color: #1f2937;
        color: #f3f4f6;
      }
      body.dark-mode .text-gray-600 {
        color: #9ca3af;
      }
    </style>
  </head>
  <body
    class="gradient-bg min-h-screen transition-colors duration-300"
    id="themeBody"
  >
    <nav class="bg-white shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-4">
            <button
              onclick="window.location.href = '/'"
              class="p-2 rounded-full hover:bg-gray-100"
            >
              <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
            </button>
            <span class="text-xl font-bold">Hồ sơ cá nhân</span>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <div class="flex flex-col md:flex-row items-center gap-8">
          <div class="relative">
            <img
              id="profileAvatar"
              src=""
              class="w-40 h-40 rounded-full border-4 border-white shadow-lg object-cover"
            />
            <button
              onclick="document.getElementById('avatarInput').click()"
              class="absolute bottom-2 right-2 bg-accent p-2 rounded-full shadow hover:opacity-90"
            >
              <i data-lucide="camera" class="w-5 h-5 text-white"></i>
            </button>
            <input type="file" id="avatarInput" hidden accept="image/*" />
          </div>
          <div class="flex-1 text-center md:text-left">
            <h1 id="profileName" class="text-3xl font-bold mb-2">Wait...</h1>
            <p id="profilePhone" class="text-gray-600 mb-4"></p>
            <div class="flex justify-center md:justify-start gap-8 text-center">
              <div>
                <div id="postCount" class="text-2xl font-bold text-accent">
                  0
                </div>
                <div class="text-sm text-gray-500">Bài viết</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-green-600">0</div>
                <div class="text-sm text-gray-500">Bạn bè</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
        <div class="flex border-b">
          <button
            onclick="switchTab('theme')"
            id="tabTheme"
            class="flex-1 py-4 font-medium text-accent border-b-2 border-accent"
          >
            Giao diện
          </button>
          <button
            onclick="switchTab('info')"
            id="tabInfo"
            class="flex-1 py-4 font-medium text-gray-500"
          >
            Thông tin
          </button>
          <button
            onclick="switchTab('security')"
            id="tabSecurity"
            class="flex-1 py-4 font-medium text-gray-500"
          >
            Bảo mật
          </button>
        </div>

        <div class="p-6">
          <div id="contentTheme">
            <h3 class="font-bold mb-4">Chế độ hiển thị</h3>
            <div class="flex gap-4 mb-6">
              <button
                onclick="setMode('light')"
                class="flex-1 p-4 border rounded-xl hover:border-accent text-left flex items-center gap-2"
              >
                <i data-lucide="sun" class="text-yellow-500"></i> Sáng
              </button>
              <button
                onclick="setMode('dark')"
                class="flex-1 p-4 border rounded-xl hover:border-accent text-left flex items-center gap-2"
              >
                <i data-lucide="moon" class="text-blue-500"></i> Tối
              </button>
            </div>

            <h3 class="font-bold mb-4">Màu chủ đạo</h3>
            <div class="flex gap-3 flex-wrap mb-6">
              <div
                class="theme-color bg-blue-500"
                onclick="setColor('#3b82f6', this)"
              ></div>
              <div
                class="theme-color bg-purple-500"
                onclick="setColor('#8b5cf6', this)"
              ></div>
              <div
                class="theme-color bg-pink-500"
                onclick="setColor('#ec4899', this)"
              ></div>
              <div
                class="theme-color bg-green-500"
                onclick="setColor('#10b981', this)"
              ></div>
              <div
                class="theme-color bg-yellow-500"
                onclick="setColor('#f59e0b', this)"
              ></div>
              <div
                class="theme-color bg-red-500"
                onclick="setColor('#ef4444', this)"
              ></div>
            </div>

            <button
              id="saveThemeBtn"
              class="bg-accent text-white px-6 py-2 rounded-lg font-medium shadow hover:opacity-90 transition w-full md:w-auto"
            >
              Lưu giao diện
            </button>
          </div>

          <div id="contentInfo" class="hidden">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Họ tên</label>
                <input
                  type="text"
                  id="inputName"
                  class="w-full p-2 border rounded-lg focus:ring-2 ring-accent focus:outline-none"
                />
              </div>
              <button
                onclick="updateProfile()"
                class="bg-accent text-white px-6 py-2 rounded-lg"
              >
                Cập nhật
              </button>
            </div>
          </div>

          <div id="contentSecurity" class="hidden text-center text-gray-500">
            Tính năng đang cập nhật...
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <i data-lucide="grid" class="text-accent"></i> Bài viết của tôi
        </h2>
        <div id="myPostsFeed" class="space-y-6"></div>
        <div id="emptyMsg" class="hidden text-center py-10 text-gray-500">
          Bạn chưa có bài viết nào.
        </div>
      </div>
    </div>

    <div id="toast" class="fixed top-4 right-4 z-50"></div>

    <script>
      lucide.createIcons();
      let currentUser = null;
      let tempTheme = "light";
      let tempColor = "#3b82f6";

      // --- CORE FUNCTIONS ---
      function getAvatar(url) {
        if (!url || url.includes("default"))
          return "/static/uploads/avatars/default_avatar.png";
        if (url.startsWith("http")) return url;
        let clean = url
          .replace("avatars/", "")
          .replace("static/", "")
          .replace("uploads/", "");
        return `/static/uploads/avatars/${clean}`;
      }

      function showToast(msg) {
        const t = document.createElement("div");
        t.className =
          "bg-accent text-white px-6 py-3 rounded-lg shadow-lg mb-2 animate__animated animate__fadeInRight";
        t.innerText = msg;
        document.getElementById("toast").appendChild(t);
        setTimeout(() => t.remove(), 3000);
      }

      // --- MAIN LOAD ---
      async function init() {
        try {
          const res = await fetch("/auth/check-auth");
          const data = await res.json();
          if (!data.authenticated) return (window.location.href = "/login");

          currentUser = data.user;
          renderUserInfo();

          // Load giao diện đã lưu
          tempTheme = currentUser.theme || "light";
          tempColor = currentUser.accent_color || "#3b82f6";
          applyVisuals(tempTheme, tempColor);

          // QUAN TRỌNG: Load bài viết sau khi có currentUser
          loadMyPosts();
        } catch (e) {
          console.error(e);
        }
      }

      function renderUserInfo() {
        document.getElementById("profileAvatar").src = getAvatar(
          currentUser.avatar_url,
        );
        document.getElementById("profileName").innerText = currentUser.name;
        document.getElementById("profilePhone").innerText =
          currentUser.phone_number;
        document.getElementById("inputName").value = currentUser.name;
      }

      // --- THEME LOGIC ---
      function setMode(mode) {
        tempTheme = mode;
        applyVisuals(tempTheme, tempColor);
      }

      function setColor(color, el) {
        tempColor = color;
        applyVisuals(tempTheme, tempColor);

        // Highlight selected circle
        document
          .querySelectorAll(".theme-color")
          .forEach((c) => c.classList.remove("selected"));
        if (el) el.classList.add("selected");
      }

      function applyVisuals(theme, color) {
        // Apply CSS Variable
        document.documentElement.style.setProperty("--accent-color", color);

        // Apply Dark Mode Class
        if (theme === "dark") document.body.classList.add("dark-mode");
        else document.body.classList.remove("dark-mode");
      }

      document.getElementById("saveThemeBtn").onclick = async () => {
        try {
          const res = await fetch("/user/update-theme", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ theme: tempTheme, accent_color: tempColor }),
          });
          if (res.ok) showToast("Đã lưu giao diện!");
        } catch (e) {
          alert("Lỗi lưu theme");
        }
      };

      // --- POSTS LOGIC (Fix lỗi trống bài) ----
      async function loadMyPosts() {
        // Gọi API với đúng user_id của người đang đăng nhập
        const res = await fetch(`/post/all?user_id=${currentUser.id}`);
        const data = await res.json();
        const feed = document.getElementById("myPostsFeed");
        feed.innerHTML = "";

        if (data.success && data.posts.length > 0) {
          document.getElementById("postCount").innerText = data.posts.length;
          data.posts.forEach((post) => {
            let imgs = "";
            if (post.images && post.images.length) {
              imgs = `<div class="grid grid-cols-${Math.min(post.images.length, 3)} gap-2 mt-3">
                            ${post.images.map((img) => `<img src="/static/uploads/posts/${img.replace("posts/", "")}" class="w-full h-48 object-cover rounded-lg">`).join("")}
                        </div>`;
            }

            const html = `
                        <div class="border-b pb-6 animate__animated animate__fadeIn">
                            <div class="flex gap-3 mb-3">
                                <img src="${getAvatar(currentUser.avatar_url)}" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <h4 class="font-bold">${currentUser.name}</h4>
                                    <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleString("vi-VN")}</p>
                                </div>
                                <button onclick="deletePost(${post.id})" class="ml-auto text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>
                            <p class="text-gray-800 whitespace-pre-wrap">${post.content || ""}</p>
                            ${imgs}
                            <div class="flex gap-6 mt-3 text-gray-500 text-sm">
                                <span class="flex items-center gap-1"><i data-lucide="heart" class="w-4 h-4"></i> ${post.like_count}</span>
                                <span class="flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> ${post.comment_count}</span>
                            </div>
                        </div>
                    `;
            feed.innerHTML += html;
          });
          lucide.createIcons();
        } else {
          document.getElementById("emptyMsg").classList.remove("hidden");
        }
      }

      async function deletePost(id) {
        if (!confirm("Xóa bài này?")) return;
        await fetch(`/post/${id}`, { method: "DELETE" });
        loadMyPosts(); // Reload lại sau khi xóa
      }

      // --- TABS LOGIC ---
      function switchTab(tab) {
        ["theme", "info", "security"].forEach((t) => {
          document
            .getElementById(`content${t.charAt(0).toUpperCase() + t.slice(1)}`)
            .classList.add("hidden");
          document.getElementById(
            `tab${t.charAt(0).toUpperCase() + t.slice(1)}`,
          ).className = "flex-1 py-4 font-medium text-gray-500";
        });
        document
          .getElementById(
            `content${tab.charAt(0).toUpperCase() + tab.slice(1)}`,
          )
          .classList.remove("hidden");
        document.getElementById(
          `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`,
        ).className =
          "flex-1 py-4 font-medium text-accent border-b-2 border-accent";
      }

      // --- AVATAR UPDATE ---
      document.getElementById("avatarInput").onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const fd = new FormData();
        fd.append("avatar", file);
        await fetch("/user/update", { method: "POST", body: fd });
        showToast("Đã cập nhật Avatar");
        setTimeout(() => location.reload(), 1000);
      };

      // --- PROFILE UPDATE ---
      async function updateProfile() {
        const name = document.getElementById("inputName").value;
        const fd = new FormData();
        fd.append("name", name);
        await fetch("/user/update", { method: "POST", body: fd });
        showToast("Đã cập nhật tên");
      }

      init();
    </script>
  </body>
</html>
